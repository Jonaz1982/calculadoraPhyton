{
  "stages": [
    {
      "stage": "ConstruccionYDespliegue",
      "displayName": "Construir y desplegar aplicación",
      "jobs": [
        {
          "job": "BuildPushACR",
          "displayName": "Construir imagen y enviarla a ACR",
          "steps": [
            {
              "task": "Docker@2",
              "inputs": {
                "containerRegistry": "tu-registro-acr",
                "repository": "nombre-de-tu-imagen",
                "command": "buildAndPush",
                "Dockerfile": "Dockerfile",
                "buildContext": ".",
                "tags": "latest"
              },
              "displayName": "Construir y enviar imagen a ACR"
            },
            {
              "script": "echo 'Validando conexión a ACR...'",
              "displayName": "Validación inicial de conexión"
            },
            {
              "script": "docker images",
              "displayName": "Listar imágenes locales"
            }
          ]
        },
        {
          "job": "DeployKubernetes",
          "displayName": "Desplegar en Kubernetes",
          "dependsOn": "BuildPushACR",
          "steps": [
            {
              "task": "Kubernetes@1",
              "inputs": {
                "connectionType": "Azure Resource Manager",
                "azureSubscription": "tu-conexion-azure",
                "azureResourceGroup": "grupo-de-recursos",
                "kubernetesCluster": "nombre-del-cluster",
                "namespace": "default",
                "command": "apply",
                "useConfigurationFile": true,
                "configuration": {
                  "apiVersion": "apps/v1",
                  "kind": "Deployment",
                  "metadata": {
                    "name": "nombre-de-tu-app",
                    "labels": {
                      "app": "nombre-de-tu-app"
                    }
                  },
                  "spec": {
                    "replicas": 2,
                    "selector": {
                      "matchLabels": {
                        "app": "nombre-de-tu-app"
                      }
                    },
                    "template": {
                      "metadata": {
                        "labels": {
                          "app": "nombre-de-tu-app"
                        }
                      },
                      "spec": {
                        "containers": [
                          {
                            "name": "nombre-de-tu-contenedor",
                            "image": "tu-registro-acr.azurecr.io/nombre-de-tu-imagen:latest",
                            "ports": [
                              {
                                "containerPort": 80
                              }
                            ]
                          }
                        ]
                      }
                    }
                  }
                }
              },
              "displayName": "Desplegar en Kubernetes"
            },
            {
              "task": "Kubernetes@1",
              "inputs": {
                "connectionType": "Azure Resource Manager",
                "azureSubscription": "tu-conexion-azure",
                "azureResourceGroup": "grupo-de-recursos",
                "kubernetesCluster": "nombre-del-cluster",
                "namespace": "default",
                "command": "expose",
                "arguments": "--type=LoadBalancer --port=80 --target-port=80 --name=servicio-app"
              },
              "displayName": "Exponer servicio en Kubernetes"
            },
            {
              "script": "kubectl get services",
              "displayName": "Validar servicios expuestos"
            }
          ]
        }
      ]
    }
  ]
}

