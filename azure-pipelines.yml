trigger:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"
  timeoutInMinutes: 10

variables:
  python.version: "3.8"

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: $(python.version)
      addToPath: true
    displayName: "Configurar Python $(python.version)"

  - script: |
      python -m pip install --upgrade pip
      pip install pytest
    displayName: "Instalar dependencias"
    timeoutInMinutes: 3

  - script: |
      echo "##[group]Estructura del proyecto"
      ls -R
      echo "##[endgroup]"

      echo "##[group]Configurando rutas"
      echo "PYTHONPATH actual: $PYTHONPATH"
      echo "##vso[task.prependpath]$PWD/app"
      echo "Nuevo PYTHONPATH: $PYTHONPATH"
      echo "##[endgroup]"
    displayName: "Configurar entorno"

  - script: |
      echo "##[group]Diagnóstico detallado"
      echo "Contenido de test/:"
      ls -la test/
      echo "Contenido de app/:"
      ls -la app/
      echo "Paths de Python:"
      python -c "import sys; print('\n'.join(sys.path))"
      echo "##[endgroup]"
    displayName: "Verificación del entorno"
    condition: always()

  - script: |
      echo "##[group]Ejecutando pruebas"
      python -m pytest test/test_calculadora.py -v
      echo "##[endgroup]"
    displayName: "Ejecutar pruebas unitarias"
    timeoutInMinutes: 5
