name: $(Build.DefinitionName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main

variables:
  TF_VAR_location: "eastus"
  TF_VAR_environment: "dev"
  TF_VAR_resource_group_name: "rgtest"
  backend_storage_account: "tfbackendstorage"
  backend_container_name: "terraform-state"
  backend_key: "iac/terraform.tfstate"

pool:
  vmImage: "ubuntu-latest"

stages:
  - stage: Terraform_Deploy
    displayName: "Despliegue de Infraestructura en Azure"
    jobs:
      - job: DeployInfra
        displayName: "Terraform Init, Plan & Apply"
        continueOnError: false
        steps:
          - task: UsePythonVersion@0
            displayName: "Seleccionar versi√≥n de Python 3.x"
            inputs:
              versionSpec: "3.x"
              addToPath: true

          - task: TerraformTaskV4@4
            name: TerraformInit
            displayName: "üå± Terraform Init"
            inputs:
              provider: "azurerm"
              command: "init"
              workingDirectory: "$(System.DefaultWorkingDirectory)/iac"
              backendServiceArm: "ConexionAzureServicePrincipal1"
              backendAzureRmResourceGroupName: "rgtest"
              backendAzureRmStorageAccountName: "rgterraformdevops01"
              backendAzureRmContainerName: "terraform"
              backendAzureRmKey: "iac/terraform.tfstate"

          - task: TerraformTaskV4@4
            name: TerraformPlan
            displayName: "üîç Terraform Plan"
            inputs:
              provider: "azurerm"
              command: "plan"
              workingDirectory: "$(System.DefaultWorkingDirectory)/iac"
              environmentServiceNameAzureRM: "ConexionAzureServicePrincipal1"
            continueOnError: true
            condition: succeeded()

          - task: TerraformTaskV4@4
            name: TerraformApply
            displayName: "üöÄ Terraform Apply"
            condition: succeeded()
            inputs:
              provider: "azurerm"
              command: "apply"
              workingDirectory: "$(System.DefaultWorkingDirectory)/iac"
              environmentServiceNameAzureRM: "ConexionAzureServicePrincipal1"

          - script: |
              echo "Mostrando recursos gestionados por Terraform:"
              terraform state list
            workingDirectory: "$(System.DefaultWorkingDirectory)/iac"
            displayName: "üìã Listar estado de Terraform"
            condition: succeeded()

          - script: |
              echo "Mostrando nombre del ACR creado:"
              terraform output acr_login_server
            workingDirectory: "$(System.DefaultWorkingDirectory)/iac"
            displayName: "üì¶ Obtener nombre del ACR"
            condition: succeeded()
