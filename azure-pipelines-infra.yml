name: $(Build.DefinitionName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main

variables:
  TF_VAR_location: "eastus"
  TF_VAR_environment: "dev"
  TF_VAR_resource_group_name: "rg-infra-dev"
  backend_storage_account: "tfbackendstorage"
  backend_container_name: "terraform-state"
  backend_key: "infra/terraform.tfstate"

pool:
  vmImage: "ubuntu-latest"

stages:
  - stage: Terraform_Deploy
    displayName: "Despliegue de Infraestructura en Azure"
    jobs:
      - job: DeployInfra
        displayName: "Terraform Init, Plan & Apply"
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: "3.x"
              addToPath: true

          - task: AzureCLI@2
            inputs:
              azureSubscription: "Conexi√≥nAzureServicePrincipal"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "##[group]Instalando Terraform"
                sudo apt-get update -y
                sudo apt-get install -y gnupg software-properties-common curl
                curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
                sudo apt-add-repository "deb https://apt.releases.hashicorp.com $(lsb_release -cs) main"
                sudo apt-get update && sudo apt-get install terraform -y
                terraform -version
                echo "##[endgroup]"
            displayName: "Instalar Terraform"

          - task: Bash@3
            displayName: "Inicializar Terraform"
            inputs:
              targetType: "inline"
              workingDirectory: "infra"
              script: |
                terraform init \
                  -backend-config="storage_account_name=$(backend_storage_account)" \
                  -backend-config="container_name=$(backend_container_name)" \
                  -backend-config="key=$(backend_key)" \
                  -backend-config="resource_group_name=$(TF_VAR_resource_group_name)" \
                  -upgrade

          - task: Bash@3
            displayName: "Plan Terraform"
            inputs:
              targetType: "inline"
              workingDirectory: "infra"
              script: |
                terraform plan -out=tfplan

          - task: Bash@3
            displayName: "Apply Terraform"
            inputs:
              targetType: "inline"
              workingDirectory: "infra"
              script: |
                terraform apply -auto-approve tfplan
