- stage: Terraform_Deploy
  displayName: "Despliegue de Infraestructura en Azure"
  jobs:
    - job: DeployInfra
      displayName: "Terraform Init, Plan & Apply"
      continueOnError: false
      steps:
        - task: UsePythonVersion@0
          displayName: "Seleccionar versi√≥n de Python 3.x"
          inputs:
            versionSpec: "3.x"
            addToPath: true

        - task: TerraformTaskV4@4
          name: TerraformInit
          displayName: "üå± Terraform Init"
          inputs:
            provider: "azurerm"
            command: "init"
            workingDirectory: "$(System.DefaultWorkingDirectory)/iac"
            backendServiceArm: "ConexionAzureServicePrincipal1"
            backendAzureRmResourceGroupName: "rgtest"
            backendAzureRmStorageAccountName: "rgterraformdevops01"
            backendAzureRmContainerName: "terraform"
            backendAzureRmKey: "iac/terraform.tfstate"

        - task: TerraformTaskV4@4
          name: TerraformPlan
          displayName: "üîç Terraform Plan"
          inputs:
            provider: "azurerm"
            command: "plan"
            condition: succeeded()
            workingDirectory: "$(System.DefaultWorkingDirectory)/iac"
            environmentServiceNameAzureRM: "ConexionAzureServicePrincipal1"
          continueOnError: true

        - task: TerraformTaskV4@4
          name: TerraformApply
          displayName: "üöÄ Terraform Apply"
          condition: succeeded()
          inputs:
            provider: "azurerm"
            command: "apply"
            workingDirectory: "$(System.DefaultWorkingDirectory)/iac"
            environmentServiceNameAzureRM: "ConexionAzureServicePrincipal1"
